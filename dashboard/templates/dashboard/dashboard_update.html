{% extends "dashboard/dashboard.html" %}

{% block update-styles %}
    <style>
        .moveable {
            border: 1px solid #d3d3d3;
            cursor: move;
        }
    </style>
{% endblock %}

{% block update-content %}
<div style='z-index: 100; position: absolute'>
    <form id='update-dashboard'>
        <button id='update-button' type='submit' disabled>Save Dashboard</button>
    </form>
    <div id='update-response' style='color: green'></div>
    <small>
        <a href="{% url 'home' %}">Back</a>
        <a href="{% url 'dashboard' %}">Dashboard</a>
    </small>
</div>
{% endblock %}

{% block update-scripts %}
<script>
    jQuery(function() {
    //TEST
    $(window).resize(function() {
        // This will execute whenever the window is resized
        var h=$(window).height(); // New height
        var w=$(window).width(); // New width
        console.log(w + 'x' + h)
    });
    //

    function disableButton() {
        $('#update-button').attr('disabled', 'disabled');
    }

    function enableButton() {
        $('#update-button').removeAttr('disabled');
    }

    function isButtonDisabled() {
        return $('#update-button').attr('disabled');
    }

    modules = [];
    // TODO: Move this into only JQuery code

    {% for module, values in modules.items %}
        {% with id=values.id|escapejs type=values.type|escapejs %}
            {% if values.moveable is True %}
                $('#id-{{ type }}-{{ id }}')
                    .addClass('moveable')
                    .ready(function() {
                        dragElement(document.getElementById('id-{{ type }}-{{ id }}'));
                });
            {% endif %}
        {% endwith %}
    {% endfor %}

    $('div').filter(function() {
        return this.id.match(/id-.+-\d+/);
    }).each(function() {
        if (!$(this).hasClass('moveable')) {
            return;
        }
        var id = $(this).attr('id').match(/id-.+-(\d+)/)[1];
        var delete_button = $('<input id="delete-' + id + '" type="button" value="X" class="module-button">');
        var edit_button = $('<input id="edit-' + id + '" type="button" value="E" class="module-button">');
        var up_button = $('<input id="up-' + id + '" type="button" value="^" class="module-button">');
        var down_button = $('<input id="down-' + id + '" type="button" value="v" class="module-button">');
        var module_div = $(this);
        module_div.children().wrapAll('<div id="module-' + id + '" class="module-container"></div>');
        sub_div = $(this).find('#module-' + id);
        if ($(this).hasClass('moveable')) {
            $(this).removeClass('moveable');
            sub_div.addClass('moveable');
        }
        var button_div = module_div.append('<div id="buttons-' + id + '" class="button-container"></div>').find('#buttons-' + id);
        button_div
            .append(delete_button)
            .append(edit_button)
            .append(up_button)
            .append(down_button)
        button_div.find('#delete-' + id).click(function() {
            console.log('delete module for ' + $(this).attr('id'));
        });
        button_div.find('#edit-' + id).click(function() {
            console.log('edit module for ' + $(this).attr('id'))
            $.ajax(
            {
                type:"GET",
                url: "/modules/" + id + "/update/",//"{#% url 'update-module' %#}",
                dataType: "json",
                data:{
                        //csrfmiddlewaretoken: '{{ csrf_token }}',
                        //'id_data[]': id_data_temp
                },
                success: function(data) 
                {
                    // TODO: modify things here? Maybe fade out save button
                    console.log('We updated the module!');
                    //$('#update-response').html('Positions saved!');
                    console.log('Response:\n' + data.content)
                    $('#dashboard').addClass('dashboard-background');
                    // TODO: append to directly after #dashboard
                    $('body').append(data.content);
                    $('#form-' + id).submit(function(e) {
                        var x = $(this).serialize();
                        console.log('serialize: ' +x);
                        $.post('/modules/' + id + '/update/', $(this).serialize(), function(data) {
                            console.log(data);
                            $('#module-' + id).html(data.content);
                            $('#update-form-' + id).remove();
                            $('#dashboard').removeClass('dashboard-background');
                            var fn = window[data.method];
                            if (typeof fn === 'function') {
                                console.log(data.method + ' is a function!');
                                fn(id);
                            }
                        });
                        e.preventDefault();
                    });
                }
            })
        });
        button_div.find('#up-' + id).click(function() {
            var z_index = parseInt(module_div.css('z-index'));
            module_div.css('z-index', z_index+1);
            enableButton();
        });
        button_div.find('#down-' + id).click(function() {
            var z_index = parseInt(module_div.css('z-index'));
            console.log('z-index: '+z_index);
            module_div.css('z-index', z_index-1);
            enableButton();
        });
    });

    //Make the DIV element draggable:
    //for (module in modules) {
    //   $('.'+module).ready(function() {
    //        dragElement(document.getElementById(module))
    //    });
    //}

    function dragElement(elmnt) {
        var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        elmnt.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            // get the mouse cursor position at startup:
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            // call a function whenever the cursor moves:
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            // calculate the new cursor position:
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            
            // check bounds and set the element's new position:
            var newX = elmnt.offsetLeft - pos1;
            var newY = elmnt.offsetTop - pos2;
            var id = elmnt.id.match(/id-.+-(\d+)/)[1];
            if (newX >= 0 && newX + $('#module-' + id).width() <= $('#dashboard')[0].clientWidth) {
                elmnt.style.left = (newX) + "px";
            }
            if (newY >= 0 && newY + $('#module-' + id).height() <= $('#dashboard')[0].clientHeight) {
                elmnt.style.top = (newY) + "px";
            }
            
            // Update positions of the buttons div
            // TODO: we may want to put this in if-statement for newX check
            
            if (parseInt($('#buttons-' + id).parent().css('left')) +
                    $('#module-' + id).width() +
                    $('#buttons-'+id).width() >= $('#dashboard')[0].clientWidth) {
                console.log('Move to the left!')
                $('#buttons-' + id).addClass('buttons-left');
                $('#buttons-' + id).css('left', -$('#buttons-' + id).width() + 'px')
            }
            else if ($('#buttons-' + id).hasClass('buttons-left')) {
                $('#buttons-' + id).removeClass('buttons-left');
                $('#buttons-' + id).css('left', '');
                console.log('Move back to the right!');
            }

            // Enable the update button if needed
            if (isButtonDisabled()) {
                enableButton();
            }
        }

        function closeDragElement() {
            /* stop moving when mouse button is released:*/
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }   
    
    function processUpdate(e) {
        if (e.preventDefault) e.preventDefault();

        var ids_to_save = [];
        $(document.body).find('div').each(function(){ 
            if (this.id.match(/id-.+-\d+/)) {
                ids_to_save.push(this.id);
            }
        });
        console.log('Saving the valid ids: [' + ids_to_save +']');

        savePositions(ids_to_save);

        // You must return false to prevent the default form behavior
        return false;
    }

    var form = document.getElementById('update-dashboard');
    if (form.attachEvent) {
        form.attachEvent('submit', processUpdate);
    } else {
        form.addEventListener('submit', processUpdate);
    }

    function savePositions(ids) {
        var id_data_temp = [];
        
        for (i in ids) {
            var id_div = $('#'+ids[i]);
            id_data_temp.push(
                JSON.stringify({
                    'id': ids[i],
                    'top': id_div.css('top'),
                    'left': id_div.css('left'),
                    'z-index': id_div.css('z-index')
                })
            );
        }
        console.log('Sending the data:\n'+id_data_temp);

        $.ajax(
        {
            type:"GET",
            url: "{% url 'dashboard-update-save' %}",
            dataType: "json",
            data:{
                    //csrfmiddlewaretoken: '{{ csrf_token }}',
                    'id_data[]': id_data_temp
            },
            success: function(data) 
            {
                // TODO: modify things here? Maybe fade out save button
                console.log('We saved the positions!');
                $('#update-response').html('Positions saved!');
                disableButton();
            }
        })
    }
    });
</script>
{% endblock %}